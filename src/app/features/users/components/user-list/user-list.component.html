<app-header></app-header>
<div class="mt-[72px] ml-[256px]">
  <app-dynamic-form [titleForm]="'Filtrar usuarios'"
    [subtitleForm]="'Rellena los campos para filtrar los usuarios'"
    [fields]="userListFields" [className]="'w-full px-24 py-12 bg-gray-50'" [endpointUrl]="userListEndpoint"
    [method]="'GET'" [backButton]="backButton" [submitButton]="userListButton" [isFilterForm]="true"
    (submitSuccess)="onSubmitSuccess($event)" (submitError)="onSubmitError($event)"
    (loading)="setLoading($event)">></app-dynamic-form>


  <section class="relative bg-gray-50 h-[60vh]">
    <div class="w-full px-24 pb-6 relative z-10 backdrop-blur-3xl">
      <section class="flex items-center justify-between">
        <app-title class="m-4" [className]="'font-sans self-center text-2xl font-semibold sm:text-3xl whitespace-nowrap'"
          [title]="'Usuarios (CNT)'"></app-title>

      <app-button (click)="toggleFormHelpers()"
        class="w-xs"
        [text]="'Añadir usuario (CNT)'" [type]="'submit'"
        [className]="'px-3 text-md font-semibold w-full py-[10px]'"></app-button>
      </section>

      @if (helpers?.length > 0) {
        <div class="overflow-x-auto p-6 rounded-xl bg-white">
          <table class="min-w-full divide-y-2 divide-gray-200">
            <thead class="ltr:text-left rtl:text-right">
              <tr class="*:font-medium *:text-gray-900">
                <th class="px-3 py-2 whitespace-nowrap">Nombre</th>
                <th class="px-3 py-2 whitespace-nowrap">Email</th>
                <th class="px-3 py-2 whitespace-nowrap">Nombre de usuario</th>
                <th class="px-3 py-2 whitespace-nowrap">Teléfono</th>
                <th class="px-3 py-2 whitespace-nowrap">Fecha de creación</th>
                <th class="px-3 py-2 whitespace-nowrap">Rol</th>
                <th class="px-3 py-2 whitespace-nowrap">Acciones</th>
              </tr>
            </thead>

            <tbody class="divide-y divide-gray-200">
              @for (helper of helpers; track helper; let i = $index) {
              <tr class="*:text-gray-900 *:first:font-medium">
                <td class="px-3 py-2 whitespace-nowrap">{{helper.name}}</td>
                <td class="px-3 py-2 whitespace-nowrap">{{helper.email}}</td>
                <td class="px-3 py-2 whitespace-nowrap">{{helper.username}}</td>
                <td class="px-3 py-2 whitespace-nowrap">{{helper.phone}}</td>
                <td class="px-3 py-2 whitespace-nowrap">{{ helper.createdAt | date:'dd/MM/yyyy HH:mm:ss' }}</td>
                <td class="px-3 py-2 whitespace-nowrap">
                  <span
                      [ngClass]="
                        helper.role[0] === 'ADMIN' ? 'inline-flex items-center rounded-md bg-red-400/10 px-2 py-1 text-xs font-medium text-red-400 inset-ring inset-ring-red-400/20' :
                        helper.role[0] === 'SYSTEM' ? 'inline-flex items-center rounded-md bg-yellow-400/10 px-2 py-1 text-xs font-medium text-yellow-500 inset-ring inset-ring-yellow-400/20' :
                        helper.role[0] === 'USER' ? 'inline-flex items-center rounded-md bg-gray-400/10 px-2 py-1 text-xs font-medium text-gray-400 inset-ring inset-ring-gray-400/20' :
                        'inline-flex items-center rounded-md bg-gray-200 px-2 py-1 text-xs font-medium text-gray-600'
                      "
                    >{{helper.role}}</span>
                </td>

                <td class="px-3 py-2 whitespace-nowrap relative">

                  <button type="button" (click)="openDropdownHelpers(i)"
                    data-target="dropdown-default"
                    class="dropdown-toggle inline-flex justify-center py-2.5 px-1 items-center gap-2 text-sm text-black rounded-full cursor-pointer font-semibold text-center shadow-xs transition-all duration-500 hover:text-purple-600  ">
                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="4"
                      viewBox="0 0 12 4" fill="none">
                      <path
                        d="M1.85624 2.00085H1.81458M6.0343 2.00085H5.99263M10.2124 2.00085H10.1707"
                        stroke="currentcolor" stroke-width="2.5" stroke-linecap="round"></path>
                    </svg>
                  </button>
                  @if (dropdownOpenHelpers[i] === true) {
                    <ul role="none" class="py-2 bg-gray-50 dark:bg-gray-900 rounded-md shadow-md absolute top-10 right-2/3 dropdown-menu z-10">
                      <li>
                        <div role="menuitem"
                          class="block cursor-pointer mx-2 transition-all .2s ease rounded-md px-6 py-2 text-md text-gray-700 hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-gray-600 dark:hover:text-white"
                          ng-reflect-ng-class="[object Object]">Editar</div>
                      </li>
                      <li>
                        <div role="menuitem"
                          class="block cursor-pointer mx-2 transition-all .2s ease rounded-md px-6 py-2 text-md text-gray-700 hover:bg-rose-100 dark:text-gray-300 dark:hover:text-white dark:hover:bg-rose-700 dark:hover:text-white">
                          Borrar</div>
                      </li>
                    </ul>
                  }
              </tr>
              }
            </tbody>
            <tfoot>
              <tr>
                <td colspan="7">
                  <ul
                    class="w-full flex justify-between items-center gap-3 text-gray-900 w-[max-content]">
                    <div
                      class="flex justify-center items-center gap-3 text-gray-900 w-[max-content] mt-5">
                      <li>
                        <button (click)="pageMove(false, pagedHelpers, 'helpers')"
                          [disabled]="currentPageHelpers <= 1" [ngClass]="{
                            'opacity-40 cursor-not-allowed': currentPageHelpers <= 1,
                            'cursor-pointer hover:bg-red-600 hover:text-white': currentPageHelpers > 1
                          }"
                          class="border-2 border-red-600 text-red-600 p-1 rounded transition-all duration-300">
                          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                            viewBox="0 0 16 16" fill="none">
                            <path d="M10.0002 11.9999L6 7.99971L10.0025 3.99719" stroke="currentcolor"
                              stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round">
                            </path>
                          </svg>
                        </button>
                      </li>

                      <li class="text-sm font-medium text-black tracking-widest"><span class="text-red-400 font-bold text-lg">{{ currentPageHelpers }}</span>/{{ totalPagesHelpers}}</li>

                      <li>
                        <button (click)="pageMove(true, pagedHelpers, 'helpers')" [disabled]="currentPageHelpers >= totalPagesHelpers"
                                [ngClass]="{
                                  'opacity-40 cursor-not-allowed': currentPageHelpers >= totalPagesHelpers,
                                  'hover:bg-red-600 hover:text-white cursor-pointer': currentPageHelpers < totalPagesHelpers
                                }"
                               class="border-2 border-red-600 text-red-600 p-1 rounded transition-all duration-300">
                          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                            viewBox="0 0 16 16" fill="none">
                            <path d="M6.00236 3.99707L10.0025 7.99723L6 11.9998"
                              stroke="currentcolor" stroke-width="1.3"
                              stroke-linecap="round" stroke-linejoin="round">
                            </path>
                          </svg>
                        </button>
                      </li>
                    </div>
                    <li class="text-md font-medium text-black text-end"><span
                        class="font-bold text-lg text-red-400">{{ totalItemsHelpers
                        }}</span> usuario(s)</li>
                  </ul>
                </td>
              </tr>
            </tfoot>
          </table>
        </div>
      } @else {
        <div
          class="p-6 rounded-xl bg-white text-center text-gray-500 text-lg font-medium">
          No hay resultados de usuarios (CNT).
        </div>
      }
      <section class="flex items-center justify-between mt-10">
        <app-title class="m-4"
          [className]="'font-sans self-center text-2xl font-semibold sm:text-3xl whitespace-nowrap'"
          [title]="'Usuarios externos'"></app-title>
        <app-button (click)="toggleFormPIN()" class="w-xs" [text]="'Añadir usuario externo'"
          [type]="'submit'"
          [className]="'px-3 text-md font-semibold w-full py-[10px]'"></app-button>
      </section>

      @if (personsInNeed?.length > 0) {

        <div class="overflow-x-auto p-6 rounded-xl bg-white">
          <table class="min-w-full divide-y-2 divide-gray-200">
            <thead class="ltr:text-left rtl:text-right">
              <tr class="*:font-medium *:text-gray-900">
                <th class="px-3 py-2 whitespace-nowrap">Nombre</th>
                <th class="px-3 py-2 whitespace-nowrap">Email</th>
                <th class="px-3 py-2 whitespace-nowrap">Teléfono</th>
                <th class="px-3 py-2 whitespace-nowrap">Acciones</th>
              </tr>
            </thead>

            <tbody class="divide-y divide-gray-200">
              @for (person of personsInNeed; track person; let i = $index) {
                <tr class="*:text-gray-900 *:first:font-medium">
                  <td class="px-3 py-2 whitespace-nowrap">{{ person.name }}</td>
                  <td class="px-3 py-2 whitespace-nowrap">{{ person.email }}</td>
                  <td class="px-3 py-2 whitespace-nowrap">{{ person.phone }}</td>

                  <td class="px-3 py-2 whitespace-nowrap relative">
                    <button type="button" (click)="openDropdownPIN(i)"
                      data-target="dropdown-default"
                      class="dropdown-toggle inline-flex justify-center py-2.5 px-1 items-center gap-2 text-sm text-black rounded-full cursor-pointer font-semibold text-center shadow-xs transition-all duration-500 hover:text-purple-600  ">
                      <svg xmlns="http://www.w3.org/2000/svg" width="12" height="4"
                        viewBox="0 0 12 4" fill="none">
                        <path
                          d="M1.85624 2.00085H1.81458M6.0343 2.00085H5.99263M10.2124 2.00085H10.1707"
                          stroke="currentcolor" stroke-width="2.5" stroke-linecap="round">
                        </path>
                      </svg>
                    </button>
                    @if (dropdownOpenPIN[i] === true) {
                      <ul role="none"
                        class="py-2 bg-gray-50 dark:bg-gray-900 rounded-md shadow-md absolute top-10 right-4/5 dropdown-menu z-10">
                        <li>
                          <div role="menuitem"
                            class="block cursor-pointer mx-2 transition-all .2s ease rounded-md px-6 py-2 text-md text-gray-700 hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-gray-600 dark:hover:text-white"
                            ng-reflect-ng-class="[object Object]">Editar</div>
                        </li>
                        <li>
                          <div role="menuitem"
                            class="block cursor-pointer mx-2 transition-all .2s ease rounded-md px-6 py-2 text-md text-gray-700 hover:bg-rose-100 dark:text-gray-300 dark:hover:text-white dark:hover:bg-rose-700 dark:hover:text-white">
                            Borrar</div>
                        </li>
                      </ul>
                    }
                  </td>
              </tr>
            }
            </tbody>
            <tfoot>
              <tr>
                <td colspan="4">
                  <ul
                    class="w-full flex justify-between items-center gap-3 text-gray-900 w-[max-content]">
                    <div class="flex justify-center items-center gap-3 text-gray-900 w-[max-content] mt-5">
                      <li>
                        <button (click)="pageMove(false, pagedPersonsInNeeds, 'persons')" [disabled]="currentPagePersonsInNeeds <= 1" [ngClass]="{
                                                                  'opacity-40 cursor-not-allowed': currentPagePersonsInNeeds <= 1,
                                                                  'cursor-pointer hover:bg-red-600 hover:text-white': currentPagePersonsInNeeds > 1
                                                                }"
                          class="border-2 border-red-600 text-red-600 p-1 rounded transition-all duration-300">
                          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                            viewBox="0 0 16 16" fill="none">
                            <path d="M10.0002 11.9999L6 7.99971L10.0025 3.99719" stroke="currentcolor"
                              stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round">
                            </path>
                          </svg>
                        </button>
                      </li>

                      <li class="text-sm font-medium text-black tracking-widest"><span
                          class="text-red-400 font-bold text-lg">{{ currentPagePersonsInNeeds }}</span>/{{
                        totalPagesPersonsInNeeds}}</li>

                      <li>
                        <!-- CAMBIAR STRING POR ENUM -->
                        <button (click)="pageMove(true, pagedPersonsInNeeds, 'persons')" [disabled]="currentPagePersonsInNeeds >= totalPagesPersonsInNeeds" [ngClass]="{
                                                        'opacity-40 cursor-not-allowed': currentPagePersonsInNeeds >= totalPagesPersonsInNeeds,
                                                        'hover:bg-red-600 hover:text-white cursor-pointer': currentPagePersonsInNeeds < totalPagesPersonsInNeeds
                                                      }"
                          class="border-2 border-red-600 text-red-600 p-1 rounded transition-all duration-300">
                          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                            viewBox="0 0 16 16" fill="none">
                            <path d="M6.00236 3.99707L10.0025 7.99723L6 11.9998" stroke="currentcolor"
                              stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round">
                            </path>
                          </svg>
                        </button>
                      </li>
                    </div>
                    <li class="text-md font-medium text-black text-end"><span class="font-bold text-lg text-red-400">{{ totalItemsPersonsInNeeds }}</span> usuario(s)</li>
                  </ul>
                </td>
              </tr>
            </tfoot>
          </table>
        </div>
      } @else {
        <div
          class="p-6 rounded-xl bg-white text-center text-gray-500 text-lg font-medium">
          No hay resultados de usuarios externos.
          </div>
      }
    </div>
  </section>
</div>

@if (isLoading){
  <app-loader class="transition-all .3s ease"></app-loader>
}
@if (toastData != null) {
  <app-toast [type]="toastData.type" (closeToast)="closeToast()"
    [text]="toastData.text" [duration]="toastData.duration"
    [className]="'transition-all .3s ease'"></app-toast>
}

@if (isFormOpenPIN){
<!-- Overlay -->
<div class="fixed inset-0 bg-black/50 flex items-center justify-center z-100">
  <!-- Contenido del modal -->
  <section
    class="bg-white rounded-xl p-6 max-w-4xl w-[max-content] mx-4 shadow-lg relative max-h-[90vh] overflow-y-auto overflow-x-hidden">
    <app-icon (click)="toggleFormPIN()" [icon]="'x'"
      [className]="'absolute right-2 top-2 cursor-pointer w-5 h-5'"></app-icon>
    <div class="flex items-center justify-between mb-5 w-[max-content]">
      <app-dynamic-form [titleForm]="'Añadir nuevo usuario externo'"
        [subtitleForm]="'Rellena los datos para añadir un nuevo usuario externo'"
        [fields]="PINFields" [className]="'w-full'"
        [endpointUrl]="PINEndpoint" [method]="'POST'"
        [backButton]="backButton" [submitButton]="addButton"
        (submitSuccess)="onSubmitSuccess($event)"
        (submitError)="onSubmitError($event)" (loading)="setLoading($event)">
      </app-dynamic-form>
    </div>

  </section>
</div>
}


@if (isFormOpenHelpers){
<!-- Overlay -->
<div class="fixed inset-0 bg-black/50 flex items-center justify-center z-100">
  <!-- Contenido del modal -->
  <section
    class="bg-white rounded-xl p-6 max-w-4xl w-[max-content] mx-4 shadow-lg relative max-h-[90vh] overflow-y-auto overflow-x-hidden">
    <app-icon (click)="toggleFormHelpers()" [icon]="'x'"
      [className]="'absolute right-2 top-2 cursor-pointer w-5 h-5'"></app-icon>
    <div class="flex items-center justify-between mb-5 w-[max-content]">
      <app-dynamic-form [titleForm]="'Añadir nuevo usuario (CNT)'"
        [subtitleForm]="'Rellena los datos para añadir un nuevo usuario interno (CNT)'"
        [fields]="HelperFields" [className]="'w-full'" [endpointUrl]="HelperEndpoint"
        [method]="'POST'" [backButton]="backButton" [submitButton]="addButton"
        (submitSuccess)="onSubmitSuccess($event)"
        (submitError)="onSubmitError($event)" (loading)="setLoading($event)">
      </app-dynamic-form>
    </div>

  </section>
</div>
}

